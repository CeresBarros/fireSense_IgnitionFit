---
title: "fireSense_FrequencyFit"
author: "Jean Marchal"
date: "July 2017"
output:
  html_document: default
  pdf_document: default
---

# Overview
Fit statistical models that can be used to parameterize the fire ignition component of landscape fire models (e.g. fireSense).

# Download the module
```{r download module, eval = FALSE, echo = TRUE}
library(SpaDES)

moduleName <- "fireSense_FrequencyFit"

workingDirectory <- tempdir() # Location where the module will be downloaded

downloadModule(moduleName, path = workingDirectory)
```

# Usage
## Module parameters
Name|Default|Description
----|:--------------|---------------------------------------------------------------------
`formula`||a formula describing the model to be fitted. Piece-wised terms can be specifed using `pw(variableName, knotName)`.
`family`|`negative.binomial`|a family function (must be wrapped with `quote()`) or a character string naming a family function. For additional details see `?family`.
`start`|`NULL`|optional starting values for the parameters to be estimated. Those are passed to `nlminb` and can be a single vector, or a list of vectors. In the latter case, only the best solution, that is, the one which minimizes the most the objective function, is kept.
`lb`|`NULL`|optional named list with up to three elements called coef, theta and knots specifying lower bounds for coefficients to be optimized over. These must be finite and will be recycled if necessary to match `length(coefficients)`.
`ub`|`NULL`|optional named list with up to three elements called coef, theta and knots specifying upper bounds for coefficients to be optimized over. These must be finite and will be recycled if necessary to match `length(coefficients)`.
`nlminb.control`|`list(iter.max = 5e3L,`<br>`eval.max=5e3L`)|optional list of control parameters to be passed to the `nlminb` optimizer. See `?nlminb`.
`trace`|`0`|non-negative integer. If > 0, tracing information on the progress of the optimization are printed every `trace` iteration. Default is 0, which turns off tracing.
`data`|`"dataFireSense_FrequencyFit"`|a character vector indicating the names of objects in the `simList` environment in which to look for variables in the model. `data` objects should be data.frames. If omitted, or if variables are not found in `data` objects, variables are searched in the `simList` environment.
`initialRunTime`|`start(simList)`|when to start this module? By default, the start time of the simulation.
`intervalRunModule`|`NA`|optional. Interval between two runs of this module, expressed in units of simulation time.
|||

## Usage example
```{r module usage example, eval = FALSE}
library(SpaDES)

# Packages required by the module
library(DEoptimR)
library(MASS)
library(magrittr)
library(numDeriv)

set.seed(1)

# Create random weather and fire frequency data
dataObject <- data.frame(
  weather = rnorm(1000, 150, 30),
  fireFrequency = rpois(1000, .5)
)

#outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 1, end = 1, timeunit = "year")

# Examples of model formula
formula <- fireFrequency ~ weather        # Without piecewise terms
formula <- fireFrequency ~ pw(weather, k) # With a piecewise term

parameters <- list(
  fireSense_FrequencyFit = list(
    formula = formula,
    family = quote(poisson),
    # start = c(1, 1),
    data = "dataObject",
    trace = 5 # Print progress every 5 iterations
  )
)

modules <- list("fireSense_FrequencyFit")
objects <- "dataObject" # Pass objects found in the global environment to the simList environment
paths <- list(
  # cachePath = file.path(outputDir, "cache"),
  modulePath = file.path("~/Documents/GitHub/McIntire-lab/modulesPrivate/") ## TODO: change this to tempdir()
  # inputPath = inputDir,
  # outputPath = outputDir
)
 
mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects, paths = paths)

spades(mySim)
```

# Events
Events are scheduled as follows:

- Module initiation
- Model fitting

## Saving
TODO: Write what is saved. (there is currently nothing saved, but this may change in the future)

# Data dependencies
## Input data
- **dataFireSense_FrequencyFit**: one or more data.frames in which to look for variables present in the model formula.

## Output data
- **fireSense_FrequencyFitted**: an object of class `fireSense_FrequencyFit`, i.e. a list containing the following elements:

    - formula (model formula)
    - family (model family)
    - coef (fitted coefficients)
    - coef.se (standard errors of fitted coefficients)

  and optionally:

  - if `formula` contains piecewise terms:
    
    - knots (knots values)
    - knots.se (standard errors of knots)

  - if `family` is `negative.binomial`:
  
    - theta (dispersion parameter)
    - theta.se (standard error of theta)

# Links to other modules
This model can be used to parameterize the fire ignition component of landscape fire models such as fireSense.

